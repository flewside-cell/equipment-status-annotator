<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Equipment Status Annotator</title>
    <style>html, body, #root { height: 100%; margin: 0; }</style>
  <!-- model-viewer -->
<script type="module" src="https://unpkg.com/@google/model-viewer@3.3.0/dist/model-viewer.min.js"></script>

<style>
  /* Стили выносок */
  .pin{width:10px;height:10px;border-radius:50%;background:#93c5fd;box-shadow:0 0 0 3px rgba(147,197,253,.25);border:1px solid rgba(255,255,255,.6);transform:translate(-50%,-50%);pointer-events:none;position:absolute;left:50%;top:50%}
  .callout{position:absolute;display:inline-flex;align-items:center;gap:8px;pointer-events:auto;user-select:none;white-space:nowrap;text-decoration:none}
  .bubble{background:rgba(2,6,12,.8);border:1px solid rgba(148,163,184,.35);backdrop-filter:blur(6px);border-radius:10px;padding:8px 12px;font-size:14px;line-height:1.15;color:#e6edf3}
  .arrow{position:relative;width:28px;height:2px;background:rgba(148,163,184,.6);border-radius:2px}
  .arrow::after{content:"";position:absolute;right:-4px;top:50%;transform:translateY(-50%);border-width:5px 0 5px 6px;border-style:solid;border-color:transparent transparent transparent rgba(148,163,184,.9)}
</style>
    <style>
  /* временно скрыть центральную таблицу/оверлей */
  #statusTable, .status-table, .center, .overlay, .panel, .table, table.center { display: none !important; }
</style>

  </head>
  <body>
    <model-viewer id="mv"
  src="public/model.glb"
  camera-controls
  shadow-intensity="0.6"
  exposure="0.9"
  tone-mapping="aces"
  environment-image="neutral"
  ar ar-modes="webxr scene-viewer quick-look"
  style="width:100%;height:100vh;background:radial-gradient(1200px 800px at 50% 20%, #0f1720, #0b0f14 60%, #080b0f)">
</model-viewer>
<div id="root"></div> <!-- если React нужен для остального -->
  <script type="module">
  const mv = document.getElementById('mv');

  // Берём параметры ?model= и ?notes= из URL (можно не задавать)
  const params = new URLSearchParams(location.search);
  const modelUrl = params.get('model');
  if (modelUrl) mv.src = modelUrl;

  const baseUrl = document.baseURI;                 // учитывает base для Pages
  const notesUrl = params.get('notes') || new URL('notes.json', baseUrl).toString();

  // грузим аннотации
  try {
    const r = await fetch(notesUrl, { cache: 'no-store' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    (data.hotspots || []).forEach(h => {
      const el = document.createElement('div');
      el.setAttribute('slot', `hotspot-${h.id}`);
      el.className = 'callout';
      el.dataset.position = `${h.position[0]} ${h.position[1]} ${h.position[2]}`;
      el.dataset.normal   = `${h.normal[0]} ${h.normal[1]} ${h.normal[2]}`;
      const [dx,dy] = h.offset || [12,-12];
      el.style.transform = `translate(${dx}px, ${dy}px)`;
      el.innerHTML = `
        <div class="pin"></div>
        <div class="arrow"></div>
        <div class="bubble">
          ${escapeHtml(h.label)}
          ${h.sub ? `<br><small>${escapeHtml(h.sub)}</small>` : ''}
          ${h.link ? `<br><a href="${h.link}" target="_blank" rel="noopener">${escapeHtml(h.link)}</a>` : ''}
        </div>`;
      mv.appendChild(el);
    });
  } catch(e) {
    console.error('notes.json load error:', e);
  }

  // Alt+клик — быстрый захват координат точки
  mv.addEventListener('click', async (ev) => {
    if (!ev.altKey) return;
    const rect = mv.getBoundingClientRect();
    const x = ev.clientX - rect.left, y = ev.clientY - rect.top;
    const hit = await mv.positionAndNormalFromPoint(x, y);
    if (!hit) return console.warn('Мимо геометрии');

    const pos = hit.position.map(v => Math.round(v*1000)/1000);
    const nrm = hit.normal.map(v => Math.round(v*1000)/1000);

    const slot = `hotspot-${Date.now()}`;
    const el = document.createElement('div');
    el.setAttribute('slot', slot);
    el.className = 'callout';
    el.dataset.position = `${pos[0]} ${pos[1]} ${pos[2]}`;
    el.dataset.normal   = `${nrm[0]} ${nrm[1]} ${nrm[2]}`;
    el.style.transform = 'translate(12px, -12px)';
    el.innerHTML = `
      <div class="pin"></div>
      <div class="arrow"></div>
      <div class="bubble">Новый хотспот<br><small>${pos.join(' ')}</small></div>`;
    mv.appendChild(el);

    console.log('Добавьте в public/notes.json:', JSON.stringify({
      id: slot,
      label: "Новый хотспот",
      sub: pos.join(' '),
      position: pos,
      normal: nrm,
      offset: [12, -12],
      link: null
    }, null, 2));
  });

  function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
</script>

  </body>
</html>
